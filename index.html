<!DOCTYPE html>
<html lang="zh-TW">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>é˜¿ç“¦éš†èªéŸ³ä¸Šå¸</title>
		<!-- Tailwind CSS for rapid styling -->
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Google Fonts: Noto Sans TC -->
		<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet" />
		<style>
			body {
				font-family: 'Noto Sans TC', sans-serif;
				background-color: #1a202c; /* Dark theme base */
				color: #e2e8f0;
			}
			/* Custom range slider styling */
			input[type='range'] {
				-webkit-appearance: none;
				background: transparent;
			}
			input[type='range']::-webkit-slider-thumb {
				-webkit-appearance: none;
				height: 16px;
				width: 16px;
				border-radius: 50%;
				background: #63b3ed;
				cursor: pointer;
				margin-top: -6px; /* You need to specify a margin in Chrome, but in Firefox and IE it is automatic */
				box-shadow: 0 0 2px #000;
			}
			input[type='range']::-webkit-slider-runnable-track {
				width: 100%;
				height: 4px;
				cursor: pointer;
				background: #4a5568;
				border-radius: 2px;
			}
			input[type='range']:focus {
				outline: none;
			}

			.role-card {
				transition: all 0.3s ease;
			}
			.role-card.active {
				border-color: #63b3ed;
				background-color: #2c5282;
				box-shadow: 0 0 10px rgba(99, 179, 237, 0.5);
			}

			/* Pulse animation for the speaking indicator */
			@keyframes pulse-ring {
				0% {
					transform: scale(0.8);
					box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
				}
				70% {
					transform: scale(1);
					box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
				}
				100% {
					transform: scale(0.8);
					box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
				}
			}
			.speaking-indicator {
				animation: pulse-ring 2s infinite;
			}

			/* Scrollbar for modal */
			::-webkit-scrollbar {
				width: 8px;
			}
			::-webkit-scrollbar-track {
				background: #2d3748;
			}
			::-webkit-scrollbar-thumb {
				background: #4a5568;
				border-radius: 4px;
			}
			::-webkit-scrollbar-thumb:hover {
				background: #718096;
			}
		</style>
	</head>

	<body class="min-h-screen flex flex-col items-center p-4">
		<!-- Header -->
		<header class="w-full max-w-md text-center mb-6 mt-4 flex flex-col items-center relative">
			<h1 class="text-3xl font-bold text-blue-400 mb-2">ğŸ›¡ï¸ é˜¿ç“¦éš†èªéŸ³ä¸Šå¸</h1>
			<p class="text-gray-400 text-sm">ä¸å‡†å·çœ‹ï¼Œå·çœ‹çš„äººæ‰‹æŒ‡æœƒè®ŠçŸ­ã€‚</p>
			<button
				id="btn-open-rules"
				class="absolute right-0 top-2 text-xs bg-gray-700 hover:bg-gray-600 border border-gray-600 text-gray-300 px-3 py-1 rounded-full transition-colors flex items-center"
			>
				<span class="mr-1">ğŸ“œ</span> è¦å‰‡
			</button>
		</header>

		<!-- Main Content -->
		<main class="w-full max-w-md space-y-5">
			<!-- Game Setup (Player Count) -->
			<section class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
				<h2 class="text-lg font-bold text-gray-200 mb-3 flex items-center"><span class="mr-2">ğŸ‘¥</span> éŠæˆ²è¨­ç½®</h2>

				<div class="space-y-4">
					<div>
						<div class="flex justify-between items-end mb-2">
							<div class="text-sm text-gray-400">
								ç©å®¶äººæ•¸:
								<span id="player-count-display" class="text-white font-bold text-2xl ml-1">5</span>
								äºº
							</div>
							<div
								id="distribution-display"
								class="text-sm font-bold px-2 py-1 rounded bg-gray-900 border border-gray-600"
							>
								<span class="text-blue-400">ğŸ”µ 3</span>
								<span class="text-gray-500 mx-1">|</span>
								<span class="text-red-400">ğŸ”´ 2</span>
							</div>
						</div>
						<input type="range" id="player-count-slider" min="5" max="10" step="1" value="5" class="w-full mb-1" />
						<div class="flex justify-between text-xs text-gray-500 px-1 font-mono">
							<span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
						</div>
					</div>

					<div
						id="config-suggestion"
						class="text-sm text-gray-300 bg-gray-900/50 p-3 rounded border border-gray-600 leading-relaxed"
					>
						<!-- Dynamic Suggestion -->
					</div>
				</div>
			</section>

			<!-- Voice Settings -->
			<section class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
				<h2 class="text-lg font-bold text-gray-200 mb-3 flex items-center"><span class="mr-2">ğŸ—£ï¸</span> èªéŸ³è¨­å®š</h2>

				<div class="space-y-4">
					<div>
						<label class="block text-sm text-gray-400 mb-1">èªé€Ÿ (Speed)</label>
						<input
							type="range"
							id="rate"
							min="0.5"
							max="1.5"
							step="0.1"
							value="0.9"
							class="w-full h-2 rounded-lg appearance-none cursor-pointer"
						/>
						<div class="flex justify-between text-xs text-gray-500 mt-1">
							<span>æ…¢</span>
							<span>æ­£å¸¸</span>
							<span>å¿«</span>
						</div>
					</div>

					<div>
						<label class="block text-sm text-gray-400 mb-1">èªéŸ³åŒ… (è‹¥ç„¡ä¸­æ–‡è«‹èª¿æ•´ç³»çµ±è¨­å®š)</label>
						<select
							id="voice-select"
							class="w-full bg-gray-700 text-white rounded p-2 text-sm border border-gray-600 focus:outline-none focus:border-blue-500"
						>
							<option value="">è¼‰å…¥ä¸­...</option>
						</select>
					</div>
				</div>
			</section>

			<!-- Role Configuration -->
			<section class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
				<div class="flex justify-between items-center mb-3">
					<h2 class="text-lg font-bold text-gray-200 flex items-center"><span class="mr-2">ğŸ­</span> è§’è‰²é…ç½®</h2>
					<span class="text-xs text-gray-500">(é»æ“Šå•Ÿç”¨ç‰¹æ®Šè§’è‰²)</span>
				</div>
				<div class="grid grid-cols-2 gap-3" id="role-container">
					<!-- Generated by JS -->
				</div>
			</section>

			<!-- Action Area -->
			<section
				class="fixed bottom-0 left-0 w-full bg-gray-900 p-4 border-t border-gray-800 flex flex-col gap-3 shadow-[0_-5px_15px_rgba(0,0,0,0.5)] z-40"
			>
				<div id="status-display" class="hidden text-center text-yellow-400 font-bold text-lg min-h-[1.75rem]">
					<!-- Current status text -->
				</div>

				<div class="flex gap-3">
					<button
						id="btn-stop"
						class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors hidden"
					>
						â¹ åœæ­¢
					</button>
					<button
						id="btn-start"
						class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg shadow-blue-900/50"
					>
						â–¶ï¸ é–‹å§‹å¤©é»‘
					</button>
				</div>
				<p class="text-center text-xs text-gray-600 pb-2">è«‹ç¢ºèªæ‰‹æ©ŸæœªéœéŸ³ä¸”éŸ³é‡å·²é–‹å•Ÿ</p>
			</section>

			<!-- Spacer for fixed footer -->
			<div class="h-32"></div>
		</main>

		<!-- Rules Modal -->
		<div
			id="rules-modal"
			class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300"
		>
			<div
				class="bg-gray-800 w-full max-w-lg rounded-xl shadow-2xl border border-gray-600 max-h-[85vh] flex flex-col transform scale-95 transition-transform duration-300"
				id="modal-content"
			>
				<div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50 rounded-t-xl">
					<h3 class="text-xl font-bold text-white flex items-center"><span class="mr-2">ğŸ“œ</span> éŠæˆ²è¦å‰‡</h3>
					<button
						id="btn-close-rules"
						class="text-gray-400 hover:text-white text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 transition-colors"
					>
						&times;
					</button>
				</div>
				<div class="p-5 overflow-y-auto space-y-6 text-gray-300 text-sm leading-relaxed">
					<!-- Distribution Table -->
					<div>
						<h4 class="text-blue-400 font-bold text-base mb-2 border-l-4 border-blue-500 pl-2">é™£ç‡Ÿé…ç½®è¡¨</h4>
						<div class="grid grid-cols-3 gap-2 text-center text-xs">
							<div class="bg-gray-700 p-2 rounded text-gray-400">äººæ•¸</div>
							<div class="bg-blue-900/40 p-2 rounded text-blue-300">å¥½äºº (äºç‘Ÿå¿ è‡£)</div>
							<div class="bg-red-900/40 p-2 rounded text-red-300">å£äºº (è«å¾·é›·å¾·)</div>

							<div class="contents font-mono">
								<div class="bg-gray-700/50 p-1">5</div>
								<div class="bg-blue-900/20 p-1">3</div>
								<div class="bg-red-900/20 p-1">2</div>
								<div class="bg-gray-700/50 p-1">6</div>
								<div class="bg-blue-900/20 p-1">4</div>
								<div class="bg-red-900/20 p-1">2</div>
								<div class="bg-gray-700/50 p-1">7</div>
								<div class="bg-blue-900/20 p-1">4</div>
								<div class="bg-red-900/20 p-1">3</div>
								<div class="bg-gray-700/50 p-1">8</div>
								<div class="bg-blue-900/20 p-1">5</div>
								<div class="bg-red-900/20 p-1">3</div>
								<div class="bg-gray-700/50 p-1">9</div>
								<div class="bg-blue-900/20 p-1">6</div>
								<div class="bg-red-900/20 p-1">3</div>
								<div class="bg-gray-700/50 p-1">10</div>
								<div class="bg-blue-900/20 p-1">6</div>
								<div class="bg-red-900/20 p-1">4</div>
							</div>
						</div>
					</div>

					<!-- Roles Info -->
					<div>
						<h4 class="text-blue-400 font-bold text-base mb-2 border-l-4 border-blue-500 pl-2">è§’è‰²èƒ½åŠ›é€ŸæŸ¥</h4>
						<ul class="space-y-3">
							<li class="bg-gray-700/30 p-2 rounded">
								<div class="flex items-center gap-2 mb-1">
									<span class="text-xl">ğŸ§™â€â™‚ï¸</span>
									<strong class="text-blue-300">æ¢…æ— (å¥½)</strong>
								</div>
								<p class="text-xs text-gray-400">
									çŸ¥é“å£äººæ˜¯èª°ï¼ˆé™¤äº†è«å¾·é›·å¾·ï¼‰ã€‚å¿…é ˆéš±è—èº«åˆ†ï¼Œè‹¥åœ¨éŠæˆ²çµæŸæ™‚è¢«åˆºå®¢åˆºæ®ºï¼Œå¥½äººé™£ç‡Ÿç›´æ¥è½æ•—ã€‚
								</p>
							</li>
							<li class="bg-gray-700/30 p-2 rounded">
								<div class="flex items-center gap-2 mb-1">
									<span class="text-xl">ğŸ‘¸</span>
									<strong class="text-blue-300">æ´¾è¥¿ç¶­çˆ¾ (å¥½)</strong>
								</div>
								<p class="text-xs text-gray-400">
									çŸ¥é“èª°æ˜¯æ¢…æ—ï¼ˆæœƒçœ‹åˆ°æ¢…æ—èˆ‡é­”ç”˜å¨œï¼Œä½†ä¸çŸ¥é“èª°æ˜¯çœŸæ¢…æ—ï¼‰ã€‚è² è²¬ä¿è­·æ¢…æ—ä¸¦å¸¶é ˜å¥½äººã€‚
								</p>
							</li>
							<li class="bg-gray-700/30 p-2 rounded">
								<div class="flex items-center gap-2 mb-1">
									<span class="text-xl">ğŸ§›â€â™€ï¸</span>
									<strong class="text-red-300">é­”ç”˜å¨œ (å£)</strong>
								</div>
								<p class="text-xs text-gray-400">å‡æ‰®æ¢…æ—ã€‚åœ¨æ´¾è¥¿ç¶­çˆ¾çœ¼ä¸­ï¼Œå¥¹èˆ‡æ¢…æ—ä¸€æ¨£æœƒèˆ‰æ‰‹ã€‚</p>
							</li>
							<li class="bg-gray-700/30 p-2 rounded">
								<div class="flex items-center gap-2 mb-1">
									<span class="text-xl">ğŸ¦¹</span>
									<strong class="text-red-300">è«å¾·é›·å¾· (å£)</strong>
								</div>
								<p class="text-xs text-gray-400">æ¢…æ—çœ‹ä¸åˆ°ä»–ã€‚ä»–åœ¨æ¢…æ—çœçœ¼ç’°ç¯€æ™‚ä¸èˆ‰æ‰‹ã€‚</p>
							</li>
							<li class="bg-gray-700/30 p-2 rounded">
								<div class="flex items-center gap-2 mb-1">
									<span class="text-xl">ğŸ‘º</span>
									<strong class="text-red-300">å¥§ä¼¯å€« (å£)</strong>
								</div>
								<p class="text-xs text-gray-400">é‚Šç·£äººã€‚å£äººçœ‹ä¸åˆ°ä»–ï¼Œä»–ä¹Ÿçœ‹ä¸åˆ°å£äººã€‚ä½†åœ¨æ¢…æ—çœ¼ä¸­ä»–æ˜¯å£äººã€‚</p>
							</li>
						</ul>
					</div>

					<div class="text-xs text-gray-500 pt-2 border-t border-gray-700">
						<p>ğŸ’¡ å°æç¤ºï¼šæ­¤å·¥å…·åƒ…è¼”åŠ©ã€Œå¤©é»‘è«‹é–‰çœ¼ã€éšæ®µçš„èªéŸ³ä¸»æŒï¼ŒéŠæˆ²éç¨‹ä¸­çš„ç™¼è¨€èˆ‡æŠ•ç¥¨è«‹ä¾æ“šå¯¦é«”æ¡ŒéŠè¦å‰‡é€²è¡Œã€‚</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			/**
			 * Avalon Narrator Logic
			 * Features: FP-style script generation, State Management, Responsive UI
			 */

			// --- 1. Data Models & Constants ---

			const ROLES = [
				{ id: 'merlin', name: 'æ¢…æ—', icon: 'ğŸ§™â€â™‚ï¸', desc: 'çœ‹åˆ°å£äºº' },
				{
					id: 'percival',
					name: 'æ´¾è¥¿ç¶­çˆ¾',
					icon: 'ğŸ‘¸',
					desc: 'çœ‹åˆ°æ¢…æ—/é­”ç”˜å¨œ'
				},
				{ id: 'mordred', name: 'è«å¾·é›·å¾·', icon: 'ğŸ¦¹', desc: 'æ¢…æ—çœ‹ä¸åˆ°' },
				{ id: 'morgana', name: 'é­”ç”˜å¨œ', icon: 'ğŸ§›â€â™€ï¸', desc: 'å‡æ‰®æ¢…æ—' },
				{ id: 'oberon', name: 'å¥§ä¼¯å€«', icon: 'ğŸ‘º', desc: 'å£äººçœ‹ä¸åˆ°' },
				// Lancelot is kept as data but hidden in UI for simplicity
				{ id: 'lancelot', name: 'è˜­æ–¯æ´›ç‰¹', icon: 'âš”ï¸', desc: 'è®Šé«”è¦å‰‡' }
			];

			const CONFIG_RULES = {
				5: { good: 3, evil: 2, text: 'å»ºè­°é…ç½®ï¼šæ¢…æ— + åˆºå®¢(æˆ–å…¶ä»–å£äºº)' },
				6: {
					good: 4,
					evil: 2,
					text: 'å»ºè­°é…ç½®ï¼šæ¢…æ— + æ´¾è¥¿ç¶­çˆ¾ + è«å¾·é›·å¾· + åˆºå®¢'
				}, // 6äººé€šå¸¸æ¯”è¼ƒé›£å¹³è¡¡ï¼Œå¸¸ç©é›™èº«åˆ†
				7: {
					good: 4,
					evil: 3,
					text: 'æ¨™æº–å±€ï¼šæ¢…æ— + æ´¾è¥¿ç¶­çˆ¾ + é­”ç”˜å¨œ + åˆºå®¢(ç„¡è«å¾·é›·å¾·)'
				},
				8: {
					good: 5,
					evil: 3,
					text: 'æ¨™æº–å±€ï¼šæ¢…æ— + æ´¾è¥¿ç¶­çˆ¾ + é­”ç”˜å¨œ + åˆºå®¢ + (å¿ è‡£x3)'
				},
				9: {
					good: 6,
					evil: 3,
					text: '9äººå±€ï¼šå¯è€ƒæ…®åŠ å…¥ è«å¾·é›·å¾· ä»¥å¢åŠ å¥½äººé›£åº¦'
				},
				10: {
					good: 6,
					evil: 4,
					text: 'æ»¿äººå±€ï¼šæ¢…æ— + æ´¾è¥¿ç¶­çˆ¾ + è«å¾·é›·å¾· + é­”ç”˜å¨œ + å¥§ä¼¯å€«(æˆ–åˆºå®¢)'
				}
			};

			// Default state
			const state = {
				roles: new Set(['merlin']),
				playerCount: 5,
				rate: 0.9,
				isPlaying: false,
				voice: null
			};

			// --- 2. Functional Core (Script Generation) ---

			/**
			 * Pure function to generate speech timeline
			 */
			function generateScript(activeRoles) {
				const has = id => activeRoles.has(id);

				const SHORT = 2000;
				const MEDIUM = 4000;
				const LONG = 6000;

				let timeline = [];
				const say = (text, delay = 1000) => timeline.push({ text, delay });

				// 1. Start
				say('å¤©é»‘è«‹é–‰çœ¼ï¼Œæ‰€æœ‰äººæŠŠçœ¼ç›é–‰ä¸Šã€‚', 3000);

				// 2. Minions (Evil)
				say(`å£äººè«‹çœçœ¼ï¼Œäº’ç›¸ç¢ºèªèº«åˆ†ã€‚${has('oberon') ? 'å¥§ä¼¯å€«æ˜¯å£äººï¼Œä½†ä»–ä¸çœçœ¼ï¼Œä½ å€‘ä¹Ÿçœ‹ä¸åˆ°ä»–ã€‚' : ''}`, LONG);
				say('å£äººè«‹é–‰çœ¼ã€‚', 2500);

				// 3. Merlin
				if (has('merlin')) {
					say('æ¢…æ—è«‹çœçœ¼ã€‚', 2000);

					let thumbText = 'é™¤äº†è«å¾·é›·å¾·ä¹‹å¤–çš„å£äººï¼Œè«‹è±èµ·å¤§æ‹‡æŒ‡è®“æ¢…æ—ç¢ºèªèº«åˆ†ã€‚';
					if (!has('mordred') && !has('oberon')) {
						thumbText = 'å£äººè«‹è±èµ·å¤§æ‹‡æŒ‡è®“æ¢…æ—ç¢ºèªèº«åˆ†ã€‚';
					} else if (has('mordred') && !has('oberon')) {
						thumbText = 'é™¤äº†è«å¾·é›·å¾·ä¹‹å¤–çš„å£äººï¼Œè«‹è±èµ·å¤§æ‹‡æŒ‡ã€‚';
					} else if (!has('mordred') && has('oberon')) {
						thumbText = 'å£äººåŒ…å«å¥§ä¼¯å€«ï¼Œè«‹è±èµ·å¤§æ‹‡æŒ‡ã€‚';
					}

					say(thumbText, LONG);
					say('å£äººè«‹æ”¶å›å¤§æ‹‡æŒ‡ã€‚', 1500);
					say('æ¢…æ—è«‹é–‰çœ¼ã€‚', 2500);
				}

				// 4. Percival
				if (has('percival')) {
					say('æ´¾è¥¿ç¶­çˆ¾è«‹çœçœ¼ã€‚', 2000);
					let merlinAction = has('morgana') ? 'æ¢…æ—èˆ‡é­”ç”˜å¨œï¼Œè«‹è±èµ·å¤§æ‹‡æŒ‡ã€‚' : 'æ¢…æ—è«‹è±èµ·å¤§æ‹‡æŒ‡ã€‚';
					say(merlinAction, LONG);
					say('æ¢…æ—èˆ‡é­”ç”˜å¨œï¼Œè«‹æ”¶å›å¤§æ‹‡æŒ‡ã€‚', 1500);
					say('æ´¾è¥¿ç¶­çˆ¾è«‹é–‰çœ¼ã€‚', 2500);
				}

				// 5. End
				say('å¤©äº®è«‹çœçœ¼ï¼', 1000);
				say('éŠæˆ²é–‹å§‹ï¼Œè«‹é¸å‡ºç¬¬ä¸€ä½éšŠé•·ã€‚', 0);

				return timeline;
			}

			// --- 3. Audio Service ---

			class AudioService {
				constructor() {
					this.synth = window.speechSynthesis;
					this.voices = [];
				}

				loadVoices() {
					return new Promise(resolve => {
						let voices = this.synth.getVoices();
						if (voices.length > 0) {
							this.voices = voices;
							resolve(voices);
						} else {
							this.synth.onvoiceschanged = () => {
								this.voices = this.synth.getVoices();
								resolve(this.voices);
							};
						}
					});
				}

				cancel() {
					this.synth.cancel();
				}

				speakSegment(text, rate, selectedVoice, delayAfter) {
					return new Promise(resolve => {
						const u = new SpeechSynthesisUtterance(text);
						u.rate = rate;
						u.lang = 'zh-TW';
						if (selectedVoice) u.voice = selectedVoice;

						updateStatus(text, true);

						u.onend = () => {
							updateStatus('...', false);
							setTimeout(resolve, delayAfter);
						};

						// Error handling: resolve anyway to prevent game lockup
						u.onerror = e => {
							console.error('Speech error', e);
							resolve();
						};

						this.synth.speak(u);
					});
				}
			}

			const audioService = new AudioService();

			// --- 4. DOM & Logic ---

			// Elements
			const el = {
				roleContainer: document.getElementById('role-container'),
				btnStart: document.getElementById('btn-start'),
				btnStop: document.getElementById('btn-stop'),
				status: document.getElementById('status-display'),
				voiceSelect: document.getElementById('voice-select'),
				rateInput: document.getElementById('rate'),
				playerSlider: document.getElementById('player-count-slider'),
				playerCountDisplay: document.getElementById('player-count-display'),
				distributionDisplay: document.getElementById('distribution-display'),
				configSuggestion: document.getElementById('config-suggestion'),
				// Modal elements
				btnOpenRules: document.getElementById('btn-open-rules'),
				btnCloseRules: document.getElementById('btn-close-rules'),
				rulesModal: document.getElementById('rules-modal'),
				modalContent: document.getElementById('modal-content')
			};

			function init() {
				renderRoles();
				initVoices();
				updateConfigInfo(); // Initial render for player count

				// Role Selection
				el.roleContainer.addEventListener('click', e => {
					const card = e.target.closest('.role-card');
					if (!card) return;
					const id = card.dataset.id;

					if (state.roles.has(id)) {
						state.roles.delete(id);
					} else {
						state.roles.add(id);
					}
					renderRoles();
				});

				// Player Count Slider
				el.playerSlider.addEventListener('input', e => {
					state.playerCount = parseInt(e.target.value);
					updateConfigInfo();
				});

				// Modal Logic
				el.btnOpenRules.addEventListener('click', openModal);
				el.btnCloseRules.addEventListener('click', closeModal);
				el.rulesModal.addEventListener('click', e => {
					if (e.target === el.rulesModal) closeModal();
				});
			}

			function renderRoles() {
				el.roleContainer.innerHTML = ROLES.map(role => {
					if (role.id === 'lancelot') return '';
					const isActive = state.roles.has(role.id);
					return `
                <div class="role-card cursor-pointer border-2 border-gray-600 bg-gray-700 rounded-lg p-3 flex flex-col items-center justify-center gap-2 select-none ${
									isActive ? 'active' : ''
								}"
                     data-id="${role.id}">
                    <div class="text-3xl">${role.icon}</div>
                    <div class="font-bold text-sm">${role.name}</div>
                    <div class="text-xs text-gray-400 text-center">${role.desc}</div>
                </div>
                `;
				}).join('');
			}

			function updateConfigInfo() {
				const cnt = state.playerCount;
				const config = CONFIG_RULES[cnt];

				el.playerCountDisplay.textContent = cnt;
				el.distributionDisplay.innerHTML = `<span class="text-blue-400">ğŸ”µ ${config.good}</span> <span class="text-gray-500 mx-1">|</span> <span class="text-red-400">ğŸ”´ ${config.evil}</span>`;
				el.configSuggestion.textContent = `ğŸ’¡ ${config.text}`;
			}

			async function initVoices() {
				const voices = await audioService.loadVoices();
				const zhVoices = voices.filter(
					v => v.lang.includes('zh') || v.lang.includes('CN') || v.lang.includes('TW') || v.lang.includes('HK')
				);
				const displayVoices = zhVoices.length > 0 ? zhVoices : voices;

				el.voiceSelect.innerHTML = displayVoices
					.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
					.join('');

				const twVoice = displayVoices.find(v => v.lang === 'zh-TW');
				if (twVoice) el.voiceSelect.value = twVoice.name;
			}

			function updateStatus(text, isSpeaking) {
				el.status.textContent = text;
				el.status.parentElement.classList.remove('hidden');
				if (isSpeaking) {
					el.status.classList.add('speaking-indicator');
					el.status.style.color = '#63b3ed';
				} else {
					el.status.classList.remove('speaking-indicator');
					el.status.style.color = '#ecc94b';
				}
			}

			// --- Modal Animations ---
			function openModal() {
				el.rulesModal.classList.remove('hidden');
				// Trigger reflow
				void el.rulesModal.offsetWidth;
				el.rulesModal.classList.remove('opacity-0');
				el.modalContent.classList.remove('scale-95');
			}

			function closeModal() {
				el.rulesModal.classList.add('opacity-0');
				el.modalContent.classList.add('scale-95');
				setTimeout(() => {
					el.rulesModal.classList.add('hidden');
				}, 300);
			}

			// --- Game Loop ---

			async function startGame() {
				if (state.isPlaying) return;
				state.isPlaying = true;

				el.btnStart.classList.add('hidden');
				el.btnStop.classList.remove('hidden');
				el.status.classList.remove('hidden');

				const selectedVoiceName = el.voiceSelect.value;
				const voice = audioService.voices.find(v => v.name === selectedVoiceName);
				const rate = parseFloat(el.rateInput.value);
				const script = generateScript(state.roles);

				try {
					// iOS Unlock
					await audioService.speakSegment('éŠæˆ²é–‹å§‹', rate, voice, 100);
					for (const step of script) {
						if (!state.isPlaying) break;
						await audioService.speakSegment(step.text, rate, voice, step.delay);
					}
				} catch (err) {
					console.error(err);
				} finally {
					stopGame();
				}
			}

			function stopGame() {
				state.isPlaying = false;
				audioService.cancel();
				el.btnStart.classList.remove('hidden');
				el.btnStop.classList.add('hidden');
				updateStatus('', false);
				el.status.classList.add('hidden');
			}

			el.btnStart.addEventListener('click', startGame);
			el.btnStop.addEventListener('click', stopGame);

			init();
		</script>
	</body>
</html>
